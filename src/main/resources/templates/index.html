<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <title>Insulin Pump Dashboard</title>
</head>
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<body>
    <!-- navbar -->
    <nav class="navbar navbar-expand-lg bg-body-tertiary mb-2">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Navbar</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="#">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Link</a>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Dropdown
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#">Action</a></li>
                            <li><a class="dropdown-item" href="#">Another action</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#">Something else here</a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link disabled" aria-disabled="true">Disabled</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- measurements container -->
    <div class="container text-center">
        <div class="row mb-3">
            <div class="col mb-3">
                <div class="d-flex flex-row">
                    <div class="p-2 text-primary-emphasis bg-primary-subtle border border-primary-subtle">Last measurements</div>
                </div>
                <div class="d-flex flex-column bg-primary-subtle border border-primary-subtle">
                    <div class="p-2" id="timelabel">Time:</div>
                    <div class="p-2" id="pressurelabel">Pressure:</div>
                    <div class="p-2" id="heartlabel">Heart Rate:</div>
                    <div class="p-2" id="bloodlabel">Blood Sugar:</div>
                    <div class="p-2" id="temperaturelabel">Temperature:</div>
                </div>
            </div>
            <!-- alarms container   -->
            <div class="col mb-3">
                <div class="d-flex flex-row">
                    <div class="p-2 text-primary-emphasis bg-primary-subtle border border-primary-subtle">Alarms</div>
                </div>
                <div class="d-flex flex-column justify-content-evenly bg-primary-subtle border border-primary-subtle">
                    <div class="p-2" id="batterylabel">Battery</div>
                    <div class="p-2" id="refilllabel">Refill</div>
                    <div class="p-2" id="ntclabel">Ntc Error</div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col mb-3">
                <div class="d-flex flex-row">
                    <div class="p-2 text-primary-emphasis bg-primary-subtle border border-primary-subtle">Grafici</div>
                </div>
                <div class="d-flex flex-row justify-content-evenly bg-primary-subtle border border-primary-subtle">
                    <div id="chart1"></div>
                    <div id="chart2"></div>
                </div>
                <div class="d-flex flex-row justify-content-evenly bg-primary-subtle border border-primary-subtle">
                    <div id="chart3"></div>
                    <div id="chart4"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Vital parameters and charts script-->
    <script>
        var heartrate_timeseries = [];
        var sistpressure_timeseries = [];
        var diastpressure_timeseries = [];
        var bloodsugar_timeseries = [];
        var temperature_timeseries = [];

        var options1 = {
            chart: {
                type: 'line',
                animations: {
                    enabled: true,
                    easing: 'linear',
                    dynamicAnimation: {
                        speed: 1000
                    }
                },
                zoom: {
                    enabled: false
                },
                toolbar: {
                    show: false
                }
            },
            series: [{
                name: 'heartrate',
                data: heartrate_timeseries
            }],
            xaxis: {
                labels: {
                    show: false,
                }
            },
            yaxis:{
                title: {
                    text: "bpm"
                }
            },
            title: {
                text: 'HeartRate Timeseries',
                align: 'center'
            },
            stroke: {
                curve: 'smooth'
            },
        }
        var options2 = {
            chart: {
                type: 'line',
                animations: {
                    enabled: true,
                    easing: 'linear',
                    dynamicAnimation: {
                        speed: 1000
                    }
                },
                zoom: {
                    enabled: false
                },
                toolbar: {
                    show: false
                }
            },
            series: [{
                    name: 'Sistolic pressure',
                    data: sistpressure_timeseries
                },
                {
                    name: 'Diastolic pressure',
                    data: diastpressure_timeseries
                }
            ],
            xaxis: {
                labels: {
                    show: false,
                }
            },
            yaxis:{
                title: {
                    text: "mmHg"
                }
            },
            title: {
                text: 'Pressure Timeseries',
                align: 'center'
            },
            animations: {
                enabled: true,
                easing: 'linear',
                dynamicAnimation: {
                    speed: 1000
                }
            },
            stroke: {
                curve: 'smooth'
            },
        }
        var options3 = {
            chart: {
                type: 'line',
                animations: {
                    enabled: true,
                    easing: 'linear',
                    dynamicAnimation: {
                        speed: 1000
                    }
                },
                zoom: {
                    enabled: false
                },
                toolbar: {
                    show: false
                }
            },
            series: [{
                name: 'bloodsugar',
                data: bloodsugar_timeseries
            }],
            xaxis: {
                labels: {
                    show: false,
                }
            },
            yaxis:{
                title: {
                    text: "mg/dL"
                }
            },
            title: {
                text: 'Blood Sugar Timeseries',
                align: 'center'
            },
            animations: {
                enabled: true,
                easing: 'linear',
                dynamicAnimation: {
                    speed: 1000
                }
            },
            stroke: {
                curve: 'smooth'
            },
        }
        var options4 = {
            chart: {
                type: 'line',
                animations: {
                    enabled: true,
                    easing: 'linear',
                    dynamicAnimation: {
                        speed: 1000
                    }
                },
                zoom: {
                    enabled: false
                },
                toolbar: {
                    show: false
                }
            },
            series: [{
                name: 'temperature',
                data: temperature_timeseries
            }],
            xaxis: {
                labels: {
                    show: false,
                },
            },
            yaxis:{
                title: {
                    text: "C°"
                }
            },
            title: {
                text: 'Temperature Timeseries',
                align: 'center'
            },
            animations: {
                enabled: true,
                easing: 'linear',
                dynamicAnimation: {
                    speed: 1000
                }
            },
            stroke: {
                curve: 'smooth'
            },
        }

        var chart1 = new ApexCharts(document.querySelector("#chart1"), options1);
        var chart2 = new ApexCharts(document.querySelector("#chart2"), options2);
        var chart3 = new ApexCharts(document.querySelector("#chart3"), options3);
        var chart4 = new ApexCharts(document.querySelector("#chart4"), options4);

        chart1.render();
        chart2.render();
        chart3.render();
        chart4.render();

        const buffer = 20;
        var tempcount = 0;

        setInterval(() => {
            const Http = new XMLHttpRequest();
            const url = 'http://localhost:8080/vitalparameters/last';
            Http.open("GET", url);
            Http.send();
            Http.onreadystatechange = (e) => {
                if (Http.readyState === 4 && Http.status === 200) {
                    const obj = JSON.parse(Http.responseText)
                    var trunc_temp = obj.temperature.substring(0, 4);
                    var trunc_time = obj.timestamp.slice(11, 19);
                    document.getElementById("timelabel").innerHTML = "Time: " + trunc_time;
                    document.getElementById("pressurelabel").innerHTML = "Pressure: " + obj.bloodPressureSystolic + "/" + obj.bloodPressureDiastolic + " mmHg";
                    document.getElementById("heartlabel").innerHTML = "HeartRate: " + obj.heartRate + " bpm";
                    document.getElementById("bloodlabel").innerHTML = "Blood Sugar: " + obj.bloodSugarLevel + " mg/dL";
                    document.getElementById("temperaturelabel").innerHTML = "Temperature: " + trunc_temp + " C°";


                    if (heartrate_timeseries.length > buffer) {
                        heartrate_timeseries.shift();
                        sistpressure_timeseries.shift();
                        diastpressure_timeseries.shift();
                        bloodsugar_timeseries.shift();
                        temperature_timeseries.shift();
                    }

                    //Aggiunge i nuovi dati in arrivo ai grafici e alle serie temporali
                    heartrate_timeseries.push({
                        x: tempcount,
                        y: obj.heartRate
                    });
                    sistpressure_timeseries.push({
                        x: tempcount,
                        y: obj.bloodPressureSystolic
                    });
                    diastpressure_timeseries.push({
                        x: tempcount,
                        y: obj.bloodPressureDiastolic
                    });
                    bloodsugar_timeseries.push({
                        x: tempcount,
                        y: obj.bloodSugarLevel
                    });
                    temperature_timeseries.push({
                        x: tempcount,
                        y: trunc_temp
                    });

                    tempcount++;

                    // Aggiorna il grafico con i nuovi dati
                    chart1.updateSeries([{
                        data: heartrate_timeseries
                    }]);
                    // Aggiorna il grafico con i nuovi dati
                    chart2.updateSeries([{
                        data: sistpressure_timeseries
                    }, {
                        data: diastpressure_timeseries
                    }]);
                    // Aggiorna il grafico con i nuovi dati
                    chart3.updateSeries([{
                        data: bloodsugar_timeseries
                    }]);
                    // Aggiorna il grafico con i nuovi dati
                    chart4.updateSeries([{
                        data: temperature_timeseries
                    }]);
                }
            }
        }, 1000);
    </script>

    <!-- Sensor status script -->
    <script>
        setInterval(function () {
            const Http = new XMLHttpRequest();
            const url='http://localhost:8080/sensors/status';
            Http.open("GET", url);
            Http.send();
            Http.onreadystatechange = (e) => {
                const obj = JSON.parse(Http.responseText)
                document.getElementById("batterylabel").innerHTML = "Battery level: " + obj.battery + "%";
                document.getElementById("refilllabel").innerHTML = "Insulin dose available: " + obj.tank;
                document.getElementById("ntclabel").innerHTML = obj.ntcStatus ? 'Ntc status: Broken' : 'Ntc status: Active';
            }
        }, 1000);
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
</body>
</html>